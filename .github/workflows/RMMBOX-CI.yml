name: Build Rust Modules (RMMBOX)

on:
  push:
    branches: [ main, develop ]
    paths: 
      - 'rmmbox/**'
      - '.github/workflows/RMMBOX-CI.yml'
  pull_request:
    branches: [ main ]
    paths: 
      - 'rmmbox/**'
      - '.github/workflows/RMMBOX-CI.yml'
  workflow_dispatch:

jobs:  

  build:
    name: Build on ${{ matrix.os }} - Python ${{ matrix.python-version }} - ${{ matrix.arch }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      max-parallel: 6  # Reduce concurrent builds to avoid cache issues
      matrix:
        include:
          # Windows x86_64
          - os: windows-latest
            python-version: '3.9'
            arch: x86_64
          - os: windows-latest
            python-version: '3.10'
            arch: x86_64
          - os: windows-latest
            python-version: '3.11'
            arch: x86_64
          - os: windows-latest
            python-version: '3.12'
            arch: x86_64
          - os: windows-latest
            python-version: '3.13'
            arch: x86_64
          
          # Linux x86_64
          - os: ubuntu-latest
            python-version: '3.9'
            arch: x86_64
          - os: ubuntu-latest
            python-version: '3.10'
            arch: x86_64
          - os: ubuntu-latest
            python-version: '3.11'
            arch: x86_64
          - os: ubuntu-latest
            python-version: '3.12'
            arch: x86_64
          - os: ubuntu-latest
            python-version: '3.13'
            arch: x86_64
            
          # macOS x86_64 (Intel)
          - os: macos-13  # Use macOS-13 for x86_64
            python-version: '3.9'
            arch: x86_64
          - os: macos-13
            python-version: '3.10'
            arch: x86_64
          - os: macos-13
            python-version: '3.11'
            arch: x86_64
          - os: macos-13
            python-version: '3.12'
            arch: x86_64
          - os: macos-13
            python-version: '3.13'
            arch: x86_64
            
          # macOS aarch64 (Apple Silicon) - only newer Python versions
          - os: macos-14
            python-version: '3.10'
            arch: aarch64
          - os: macos-14
            python-version: '3.11'
            arch: aarch64
          - os: macos-14
            python-version: '3.12'
            arch: aarch64
          - os: macos-14
            python-version: '3.13'
            arch: aarch64

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        # Fix architecture setting for different platforms - use auto for macOS-14 (Apple Silicon)
        architecture: ${{ matrix.os == 'macos-14' && 'auto' || (matrix.arch == 'x86_64' && 'x64' || 'auto') }}

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.arch == 'aarch64' && (matrix.os == 'macos-14' && 'aarch64-apple-darwin' || 'aarch64-unknown-linux-gnu') || (startsWith(matrix.os, 'windows') && 'x86_64-pc-windows-msvc' || startsWith(matrix.os, 'ubuntu') && 'x86_64-unknown-linux-gnu' || 'x86_64-apple-darwin') }}

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        enable-cache: true

    - name: Set up cross-compilation (Linux aarch64)
      if: matrix.os == 'ubuntu-latest' && matrix.arch == 'aarch64'
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-aarch64-linux-gnu
        echo "CC_aarch64_unknown_linux_gnu=aarch64-linux-gnu-gcc" >> $GITHUB_ENV
        echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc" >> $GITHUB_ENV

    - name: Set environment variables for cross-compilation
      shell: bash
      run: |
        if [[ "${{ matrix.arch }}" == "aarch64" ]]; then
          if [[ "${{ runner.os }}" == "macOS" ]]; then
            echo "CARGO_BUILD_TARGET=aarch64-apple-darwin" >> $GITHUB_ENV
          elif [[ "${{ runner.os }}" == "Linux" ]]; then
            echo "CARGO_BUILD_TARGET=aarch64-unknown-linux-gnu" >> $GITHUB_ENV
          fi
        else
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            echo "CARGO_BUILD_TARGET=x86_64-pc-windows-msvc" >> $GITHUB_ENV
          elif [[ "${{ runner.os }}" == "Linux" ]]; then
            echo "CARGO_BUILD_TARGET=x86_64-unknown-linux-gnu" >> $GITHUB_ENV
          elif [[ "${{ runner.os }}" == "macOS" ]]; then
            echo "CARGO_BUILD_TARGET=x86_64-apple-darwin" >> $GITHUB_ENV
          fi
        fi

    - name: Display build environment
      shell: bash
      run: |
        echo "OS: ${{ runner.os }}"
        echo "Architecture: ${{ matrix.arch }}"
        echo "Python version: ${{ matrix.python-version }}"
        python --version
        python -c "import sys; print(f'Python: {sys.version}'); print(f'Platform: {sys.platform}'); print(f'Architecture: {sys.maxsize > 2**32 and \"64-bit\" or \"32-bit\"}')"
        rustc --version
        cargo --version
        uv --version

    - name: Build Rust modules
      shell: bash
      working-directory: rmmbox
      run: |
        python build_all.py

    - name: List generated files
      shell: bash
      run: |
        echo "=== Generated binary files ==="
        find src/pyrmm/usr/lib -name "*.pyd" -o -name "*.so" | head -20
        echo ""
        echo "=== File details ==="
        find src/pyrmm/usr/lib -name "*.pyd" -o -name "*.so" -exec ls -la {} \;

    - name: Test import modules
      shell: bash
      run: |
        echo "=== Testing module imports ==="
        cd src
        python -c "
        import sys
        sys.path.insert(0, '.')
        
        print('Testing imports...')
        try:
            import pyrmm.usr.lib.fs as fs_module
            print('✅ fs module imported successfully')
            print(f'fs.ROOT: {fs_module.ROOT}')
        except Exception as e:
            print(f'❌ fs module import failed: {e}')
        
        try:
            import pyrmm.usr.lib.config as config_module
            print('✅ config module imported successfully')
            # Test basic functionality
            config_module.Config.init()
            print('✅ config module functionality test passed')
        except Exception as e:
            print(f'❌ config module import failed: {e}')
        
        try:
            import pyrmm.usr.lib.basic as basic_module
            print('✅ basic module imported successfully')
            print(f'basic.CUSTOMIZE_SH length: {len(basic_module.CUSTOMIZE_SH)}')
        except Exception as e:
            print(f'❌ basic module import failed: {e}')
        "

    - name: Create artifact name
      shell: bash
      run: |
        OS_NAME="${{ runner.os }}"
        if [[ "$OS_NAME" == "Windows" ]]; then
          OS_LOWER="windows"
          EXT="pyd"
        elif [[ "$OS_NAME" == "macOS" ]]; then
          OS_LOWER="macos"
          EXT="so"
        else
          OS_LOWER="linux"
          EXT="so"
        fi
        
        ARTIFACT_NAME="rust-modules-${OS_LOWER}-${{ matrix.arch }}-py${{ matrix.python-version }}"
        echo "ARTIFACT_NAME=${ARTIFACT_NAME}" >> $GITHUB_ENV
        echo "BINARY_EXT=${EXT}" >> $GITHUB_ENV

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.ARTIFACT_NAME }}
        path: |
          src/pyrmm/usr/lib/*.${{ env.BINARY_EXT }}
        retention-days: 30

  commit-modules:
    name: Commit built modules to repository
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Organize and copy modules to target directory
      run: |
        echo "=== Organizing downloaded artifacts ==="
        find artifacts -type f -name "*.pyd" -o -name "*.so" | sort
        
        # Ensure target directory exists
        mkdir -p src/pyrmm/usr/lib
        
        # Copy all .pyd and .so files to target directory
        find artifacts -type f \( -name "*.pyd" -o -name "*.so" \) -exec cp {} src/pyrmm/usr/lib/ \;
        
        echo ""
        echo "=== Files copied to src/pyrmm/usr/lib/ ==="
        ls -la src/pyrmm/usr/lib/*.{pyd,so} 2>/dev/null || echo "No .pyd/.so files found"

    - name: Check for changes
      id: changes
      run: |
        git add src/pyrmm/usr/lib/
        if git diff --staged --quiet; then
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "No changes to commit"
        else
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "Changes detected:"
          git diff --staged --name-only
        fi

    - name: Commit and push changes
      if: steps.changes.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Get current branch name
        BRANCH_NAME="${GITHUB_REF#refs/heads/}"
        
        # Count files by type
        PYD_COUNT=$(find src/pyrmm/usr/lib -name "*.pyd" 2>/dev/null | wc -l)
        SO_COUNT=$(find src/pyrmm/usr/lib -name "*.so" 2>/dev/null | wc -l)
        
        git add src/pyrmm/usr/lib/
        git commit -m "🤖 Auto-update Rust modules from CI
        
        - Built ${PYD_COUNT} .pyd files (Windows)
        - Built ${SO_COUNT} .so files (macOS/Linux)  
        - Python versions: 3.9, 3.10, 3.11, 3.12, 3.13
        - Platforms: Windows (x86_64), macOS (x86_64, aarch64), Linux (x86_64)
        - Commit: ${GITHUB_SHA:0:7}
        - Workflow: ${{ github.run_number }}"
        
        git push origin "$BRANCH_NAME"
        
        echo "✅ Successfully committed and pushed updated Rust modules"

    - name: Summary
      run: |
        echo "=== Build Summary ==="
        echo "Branch: ${GITHUB_REF#refs/heads/}"
        echo "Commit: ${GITHUB_SHA:0:7}"
        echo "Workflow Run: ${{ github.run_number }}"
        echo ""
        echo "Updated modules in src/pyrmm/usr/lib/:"
        ls -la src/pyrmm/usr/lib/*.{pyd,so} 2>/dev/null || echo "No modules found"
